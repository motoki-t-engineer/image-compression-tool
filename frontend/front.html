<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像圧縮アプリ（簡易版）</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div id="app" class="container my-5">
    <h2 class="mb-4">画像圧縮アプリ（簡易版）</h2>

    <form @submit.prevent="submit" class="mb-3">
      <div class="mb-3">
        <label class="form-label">画像ファイル（複数可）</label>
        <input type="file" multiple @change="handleFiles" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">出力形式</label>
        <select v-model="format" class="form-select">
          <option value="jpeg">JPEG</option>
          <option value="png">PNG</option>
          <option value="gif">GIF</option>
        </select>
      </div>

      <div class="mb-3" v-if="format==='jpeg'">
        <label class="form-label">圧縮率: {{ quality }}%</label>
        <input type="range" v-model="quality" min="10" max="100" class="form-range">
      </div>

      <button type="submit" class="btn btn-primary">圧縮する</button>
    </form>

    <div v-if="loading" class="alert alert-info">
      処理中です…
    </div>

    <div v-if="downloadUrls.length" class="mt-4">
      <h4>圧縮後の画像</h4>
      <div v-for="(url, index) in downloadUrls" :key="index" class="mb-2">
        <a :href="url" target="_blank" class="btn btn-success btn-sm">ダウンロード {{ index+1 }}</a>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          files: [],
          format: 'jpeg',
          quality: 80,
          loading: false,
          downloadUrls: []
        };
      },
      methods: {
        handleFiles(event) {
          this.files = Array.from(event.target.files);
        },

        async submit() {
          if (!this.files.length) return alert("ファイルを選択してください");
          this.loading = true;
          this.downloadUrls = [];

          const apiUrl = "YOUR_API_GATEWAY_URL"; // Lambda API Gateway URL に置き換え

          for (const file of this.files) {
            const base64Data = await this.fileToBase64(file);

            const payload = {
              filename: file.name,
              fileContent: base64Data,
              format: this.format,
              quality: this.quality
            };

            try {
              const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });

              const data = await response.json();
              this.downloadUrls.push(data.signedUrl);
            } catch (err) {
              console.error(err);
              alert("処理中にエラーが発生しました");
            }
          }

          this.loading = false;
        },

        fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
              const base64 = reader.result.split(',')[1]; // data:image/...;base64,... を切り出す
              resolve(base64);
            };
            reader.onerror = error => reject(error);
          });
        }
      }
    }).mount("#app");
  </script>
</body>
</html>